<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Cryptocurrency Ticker</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
    </style>
</head>
<body>
<h2>Live Cryptocurrency Prices</h2>

<table>
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Symbol</th>
        <th>Price</th>
    </tr>
    </thead>
    <tbody id="cryptoTableBody">
    </tbody>
</table>

<script>
    const socket = new SockJS('/ws'); // Ensure this matches your Spring endpoint
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        stompClient.subscribe('/market/public', function (message) {
            const data = JSON.parse(message.body);
            updateTable(data);
        });

        fetch('/market/public/load')
        .then(response => response.json())
        .then(data => {
            initTable(data);
        })
        .catch(error => {
            console.error('Error loading initial market data:', error);
        });
    });

    function initTable(data) {
        const tbody = document.getElementById('cryptoTableBody');
        tbody.innerHTML = ''; // Clear any existing rows
        let i = 1;

        data.forEach(crypto => {
            const row = document.createElement('tr');
            row.id = crypto.symbol;

            row.innerHTML = `
                <td>${i}</td>
                <td>${crypto.name}</td>
                <td>${crypto.symbol}</td>
                <td>${crypto.price}</td>
            `;

            tbody.appendChild(row);
            i++;
        });
    }

    function updateTable(data) {
        const tbody = document.getElementById('cryptoTableBody');
        let existingRow = document.getElementById(data.symbol);

        if (!existingRow) {
            const newRow = document.createElement('tr');
            newRow.id = data.symbol;
            newRow.innerHTML = `
                <td>${data.name}</td>
                <td>${data.symbol}</td>
                <td>${data.price}</td>
            `;
            tbody.appendChild(newRow);
        } else {
            existingRow.cells[3].textContent = data.price;
        }
    }
</script>
</body>
</html>
